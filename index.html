<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Bitwise Dungeon: Reloaded</title>
    <style>
        /* --- CSS: Cyberpunk Theme --- */
        :root {
            --bg-color: #050505;
            --terminal-bg: #101010;
            --text-main: #e0e0e0;
            --accent: #00ff41;       /* Verde Matrix */
            --accent-dim: #008f11;
            --secondary: #00e5ff;    /* Ciano Cyber */
            --error: #ff3333;
            --font-mono: 'Consolas', 'Monaco', monospace;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: var(--font-mono);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        .game-container {
            width: 100%;
            max-width: 950px;
        }

        /* HUD Header */
        header {
            display: flex;
            justify-content: space-between;
            border-bottom: 2px solid var(--accent);
            padding-bottom: 15px;
            margin-bottom: 25px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-size: 0.9rem;
        }

        .stat-val { color: var(--accent); font-weight: bold; }

        /* Terminal Window */
        .terminal {
            background: var(--terminal-bg);
            border: 1px solid #333;
            border-radius: 4px;
            padding: 30px;
            box-shadow: 0 0 30px rgba(0, 255, 65, 0.05);
            position: relative;
        }

        h2 { margin: 0 0 15px 0; color: var(--secondary); font-size: 1.4rem; }
        
        .story-log {
            color: #888;
            border-left: 3px solid var(--accent-dim);
            padding-left: 15px;
            margin-bottom: 30px;
            font-style: italic;
        }

        /* Challenge Display */
        .challenge-box {
            background: rgba(255,255,255,0.03);
            border: 1px dashed #444;
            padding: 20px;
            text-align: center;
            margin-bottom: 25px;
            font-size: 1.8rem;
            font-weight: bold;
            letter-spacing: 2px;
        }

        /* Input Zone */
        .input-zone { display: flex; gap: 15px; margin-bottom: 25px; }
        
        input {
            flex: 1;
            background: #000;
            border: 1px solid #444;
            color: var(--accent);
            font-family: var(--font-mono);
            font-size: 1.3rem;
            padding: 12px;
            outline: none;
        }
        input:focus { border-color: var(--accent); box-shadow: 0 0 8px rgba(0,255,65,0.2); }

        button {
            background: var(--accent-dim);
            color: #fff;
            border: none;
            padding: 0 30px;
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
            font-family: var(--font-mono);
        }
        button:hover { background: var(--accent); color: #000; }

        /* Live Explanation Area */
        .live-explain {
            background: #000;
            border-top: 2px solid #222;
            padding: 15px;
            font-size: 0.9rem;
            color: #ccc;
            min-height: 60px;
        }
        
        .math { color: var(--secondary); }
        .bit-row { display: flex; gap: 4px; justify-content: center; margin-top:10px; }
        .bit-box { border:1px solid #555; padding:4px 8px; font-size:0.8rem; }
        .bit-s { border-color: #ff4444; color:#ff4444; } /* Sign */
        .bit-e { border-color: #ffd700; color:#ffd700; } /* Exp */
        .bit-m { border-color: #00e5ff; color:#00e5ff; } /* Mantissa */

        /* Immagine ASCII Helper */
        #asciiHelper {
            display: none; /* Nascosto di default */
            margin-top: 20px;
            text-align: center;
        }
        #asciiHelper img {
            max-width: 100%;
            height: auto;
            background: #fff; /* Tabella nera su bianco */
            padding: 5px;
            border-radius: 4px;
            opacity: 0.9;
        }

        /* Utility animations */
        .shake { animation: shake 0.4s ease-in-out; border-color: var(--error) !important; }
        @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-5px)} 75%{transform:translateX(5px)} }

    </style>
</head>
<body>

<div class="game-container">
    <header>
        <div>Livello: <span id="lvlDisplay" class="stat-val">1</span> / 4</div>
        <div>Grado: <span id="rankDisplay">Novizio</span></div>
        <div>XP: <span id="xpDisplay" class="stat-val">0</span></div>
    </header>

    <div class="terminal">
        <h2 id="title">Inizializzazione...</h2>
        <div id="story" class="story-log">...</div>

        <div id="challenge" class="challenge-box"></div>
        
        <div id="asciiHelper">
            <p style="font-size:0.8rem; color:#888;">// Riferimento Intercettato: Tabella US-ASCII</p>
            <img src="https://upload.wikimedia.org/wikipedia/commons/c/cf/USASCII_code_chart.png" alt="ASCII Table">
        </div>

        <div class="input-zone">
            <input type="text" id="userInput" placeholder="Inserisci soluzione..." autocomplete="off">
            <button onclick="Game.checkAnswer()">INVIA DATI</button>
        </div>

        <div id="feedback" class="live-explain">
            // In attesa di input...
        </div>
    </div>
</div>

<script>
/**
 * THE BITWISE DUNGEON: RELOADED
 * Un motore di gioco educativo per conversioni numeriche.
 */

/* --- Configurazione Livelli --- */
const LEVELS = [
    {
        id: 1,
        title: "Binarizzazione",
        rank: "Script Kiddie",
        story: "Il gatekeeper parla solo in logica booleana. Converti il flusso binario in un numero decimale per aprire la porta.",
        type: "BIN_DEC",
        hint: "Somma le potenze di 2 dove vedi '1' (1, 2, 4, 8, 16...).",
        generate: () => Math.floor(Math.random() * 26) + 6, // Num tra 6 e 31
        formatPrompt: (val) => `Binary: ${val.toString(2)}`,
        check: (input, target) => parseInt(input) === target
    },
    {
        id: 2,
        title: "Hex Dump Parsing",
        rank: "White Hat",
        story: "Sei dentro. La memoria è indirizzata in esadecimale per risparmiare spazio. Traduci l'indirizzo Hex in decimale.",
        type: "HEX_DEC",
        hint: "A=10, B=11 ... F=15. Moltiplica la prima cifra per 16 e aggiungi la seconda.",
        generate: () => Math.floor(Math.random() * 200) + 20, // Num tra 20 e 220
        formatPrompt: (val) => `Hex: 0x${val.toString(16).toUpperCase()}`,
        check: (input, target) => parseInt(input) === target
    },
    {
        id: 3,
        title: "Decodifica ASCII",
        rank: "Cryptographer",
        story: "Hai trovato un messaggio lasciato da un admin. È una sequenza di byte Hex che rappresentano caratteri ASCII. Usa la tabella per leggere il messaggio.",
        type: "ASCII",
        hint: "Coordinate Hex: cerca la PRIMA cifra nelle colonne in alto e la SECONDA cifra nelle righe a sinistra. Cerca ogni coppia esadecimale nella tabella (colonne e righe) per trovare la lettera.",
        words: ["ROOT", "USER", "PASS", "BIOS", "BOOT", "NULL"],
        generate: function() { return this.words[Math.floor(Math.random() * this.words.length)]; },
        formatPrompt: (val) => {
            // Converte la parola in stringa di codici Hex (es: "52 4F 4F 54")
            let hexStr = "";
            for(let i=0; i<val.length; i++) {
                hexStr += val.charCodeAt(i).toString(16).toUpperCase() + " ";
            }
            return `Msg: ${hexStr.trim()}`;
        },
        check: (input, target) => input.trim().toUpperCase() === target
    },
    {
        id: 4,
        title: "Il Core IEEE 754",
        rank: "Bit Wizard",
        story: "Sei nel nucleo matematico. I numeri sono float a 32-bit. Inserisci il valore del bit di SEGNO e il valore decimale dell'ESPONENTE.",
        type: "IEEE",
        hint: "Formato: 'SEGNO, ESPONENTE'. Ricorda: Esponente Binario - Bias (127) non serve qui, voglio il valore raw (0-255).",
        generate: () => {
            // Genera float semplici (es: -12.0, 4.5)
            const s = Math.random() > 0.5 ? 1 : -1;
            const bases = [2, 4, 8, 16];
            return s * (bases[Math.floor(Math.random()*bases.length)] + (Math.random() > 0.5 ? 0.5 : 0));
        },
        formatPrompt: (val) => `Float: ${val}`,
        check: (input, target) => {
            // Estrazione reale dei bit
            const view = new DataView(new ArrayBuffer(4));
            view.setFloat32(0, target);
            const bits = view.getUint32(0).toString(2).padStart(32, '0');
            const realSign = bits[0];
            const realExp = parseInt(bits.substring(1, 9), 2);
            
            // Parsing input utente "S, E"
            const parts = input.split(/[, ]+/); // Split su virgola o spazio
            if(parts.length < 2) return false;
            return parts[0] === realSign && parseInt(parts[1]) === realExp;
        }
    }
];

/* --- Game Engine --- */
const Game = {
    currLevel: 0,
    currTarget: null,
    xp: 0,

    // UI References
    ui: {
        lvl: document.getElementById('lvlDisplay'),
        rank: document.getElementById('rankDisplay'),
        xp: document.getElementById('xpDisplay'),
        title: document.getElementById('title'),
        story: document.getElementById('story'),
        box: document.getElementById('challenge'),
        input: document.getElementById('userInput'),
        feedback: document.getElementById('feedback'),
        ascii: document.getElementById('asciiHelper')
    },

    init: function() {
        this.loadLevel(0);
        
        // Listener per feedback in tempo reale
        this.ui.input.addEventListener('input', (e) => this.explainLive(e.target.value));
        
        // Enter key
        this.ui.input.addEventListener('keypress', (e) => {
            if(e.key === 'Enter') this.checkAnswer();
        });
    },

    loadLevel: function(idx) {
        if(idx >= LEVELS.length) {
            this.victory();
            return;
        }
        this.currLevel = idx;
        const cfg = LEVELS[idx];

        // Update UI
        this.ui.lvl.innerText = cfg.id;
        this.ui.rank.innerText = cfg.rank;
        this.ui.title.innerText = `Lvl ${cfg.id}: ${cfg.title}`;
        this.ui.story.innerText = cfg.story;
        this.ui.input.value = "";
        this.ui.feedback.innerText = "// In attesa di dati...";
        
        // Gestione ASCII Image
        this.ui.ascii.style.display = (cfg.type === "ASCII") ? "block" : "none";

        // Generate puzzle
        this.currTarget = cfg.generate();
        this.ui.box.innerText = cfg.formatPrompt(this.currTarget);
        this.ui.input.focus();
    },

    explainLive: function(val) {
        const type = LEVELS[this.currLevel].type;
        let html = "";

        if (!val) { this.ui.feedback.innerHTML = "// ..."; return; }

        if (type === "BIN_DEC") {
            // Mostra scomposizione del target (aiuto didattico)
            const bin = this.currTarget.toString(2);
            let parts = [];
            for(let i=0; i<bin.length; i++) {
                if(bin[i] === '1') parts.push(`2^${bin.length-1-i}`);
            }
            html = `Hint: ${bin} = <span class="math">${parts.join(' + ')}</span>`;
        }
        else if (type === "HEX_DEC") {
            const hex = this.currTarget.toString(16).toUpperCase();
            html = `Hint: 0x${hex} = `;
            let parts = [];
            for(let i=0; i<hex.length; i++) {
                let digit = parseInt(hex[i], 16);
                parts.push(`(${digit} × 16^${hex.length-1-i})`);
            }
            html += `<span class="math">${parts.join(' + ')}</span>`;
        }
        else if (type === "ASCII") {
            // Converte input utente in Hex live per mostrare la relazione
            let hexOut = "";
            for(let i=0; i<val.length; i++) {
                hexOut += val.charCodeAt(i).toString(16).toUpperCase() + " ";
            }
            html = `Tuo input "${val}" in Hex: <span class="math">${hexOut}</span>`;
        }
        else if (type === "IEEE") {
            // Visualizzatore bit per il target float
            const view = new DataView(new ArrayBuffer(4));
            view.setFloat32(0, this.currTarget);
            const bits = view.getUint32(0).toString(2).padStart(32, '0');
            
            html = `Struttura Bit del Target (${this.currTarget}):
            <div class="bit-row">
                <span class="bit-box bit-s" title="Segno">${bits[0]}</span>
                <span class="bit-box bit-e" title="Esponente 8-bit">${bits.substring(1,9)}</span>
                <span class="bit-box bit-m" title="Mantissa">${bits.substring(9,16)}...</span>
            </div>
            <div style="margin-top:5px">Inserisci: Segno (0/1) , Esponente Decimale (0-255)</div>`;
        }

        this.ui.feedback.innerHTML = html;
    },

    checkAnswer: function() {
        const val = this.ui.input.value;
        const cfg = LEVELS[this.currLevel];

        if(cfg.check(val, this.currTarget)) {
            // Success
            this.xp += 150 * (this.currLevel + 1);
            this.ui.xp.innerText = this.xp;
            this.ui.feedback.innerHTML = "<strong style='color:var(--accent)'>>> MATCH CONFERMATO. Accesso livello successivo.</strong>";
            this.ui.input.style.borderColor = "var(--accent)";
            
            setTimeout(() => {
                this.ui.input.style.borderColor = "#444";
                this.loadLevel(this.currLevel + 1);
            }, 1200);
        } else {
            // Fail
            this.ui.input.classList.add('shake');
            this.ui.feedback.innerHTML = `<strong style="color:var(--error)">>> ERRORE DI PARSING.</strong><br>${cfg.hint}`;
            setTimeout(() => this.ui.input.classList.remove('shake'), 500);
        }
    },

    victory: function() {
        this.ui.box.style.display = 'none';
        this.ui.input.style.display = 'none';
        this.ui.ascii.style.display = 'none';
        this.ui.title.innerText = "SISTEMA CONQUISTATO";
        this.ui.story.innerHTML = `
            <h1 style="color:var(--accent); text-align:center">COMPLETED</h1>
            <p style="text-align:center">Hai dimostrato una conoscenza superiore dei formati low-level.</p>
            <p style="text-align:center; font-size:1.5rem">Punteggio Finale: ${this.xp} XP</p>
            <div style="text-align:center; margin-top:30px">
                <button onclick="location.reload()">REBOOT SYSTEM</button>
            </div>
        `;
        this.ui.feedback.innerHTML = "// Sessione terminata.";
    }
};

// Start
Game.init();

</script>
</body>
</html>
